<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitor Hemodinámico Web</title>
  <style>
    :root{
      --bg:#0b0d10;
      --tile:#2a2c2f;
      --tile2:#1c1e21;
      --bevelHi:rgba(255,255,255,.18);
      --bevelLo:rgba(0,0,0,.7);
      --text:#e9eef5;
      --muted:#aab4c2;
      --accent:#55b7ff;
      --danger:#ff3b30;
      --warn:#ffd60a;
      --ok:#34c759;
      --shadow: rgba(0,0,0,.6);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 50% -200px, #24303b 0%, var(--bg) 60%),
                  radial-gradient(900px 600px at 80% 120%, #101723 0%, var(--bg) 55%);
      color:var(--text);
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .monitor{
      width:min(980px, 96vw);
      aspect-ratio: 1.32/1;
      background: linear-gradient(180deg, #0f1217, #07080a);
      border-radius: 14px;
      border: 2px solid rgba(255,255,255,.08);
      box-shadow:
        0 18px 55px rgba(0,0,0,.65),
        inset 0 1px 0 rgba(255,255,255,.08);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .topbar{
      height:46px;
      display:flex;
      align-items:center;
      padding:0 12px;
      gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.35));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{
      font-weight:700;
      letter-spacing:.2px;
      opacity:.95;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pill{
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.08);
      color:var(--muted);
    }
    .spacer{flex:1}
    .select, .btn{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 10px;
      height:30px;
      padding:0 10px;
      font-size:12px;
      outline:none;
    }
    .btn{
      cursor:pointer;
      transition: transform .06s ease, background .2s ease;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(85,183,255,.35); box-shadow: inset 0 0 0 1px rgba(85,183,255,.15); }
    .btn.danger{ border-color: rgba(255,59,48,.35); box-shadow: inset 0 0 0 1px rgba(255,59,48,.12); }

    .grid{
      flex:1;
      display:grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap:10px;
      padding:10px;
    }
    .tile{
      position:relative;
      border-radius: 12px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.35)),
        linear-gradient(180deg, var(--tile), var(--tile2));
      border:1px solid rgba(255,255,255,.10);
      box-shadow:
        inset 0 1px 0 var(--bevelHi),
        inset 0 -2px 10px rgba(0,0,0,.55),
        0 10px 24px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .tile::before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(700px 240px at 50% 0%, rgba(255,255,255,.09), transparent 60%);
      pointer-events:none;
    }
    .dialWrap{
      position:absolute;
      inset:10px 10px 10px 10px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas.gauge{
      width:100%;
      height:100%;
      max-width: 420px;
      max-height: 260px;
    }
    .label{
      position:absolute;
      left:0; right:0;
      bottom:16px;
      text-align:center;
      font-size:22px;
      font-weight:800;
      letter-spacing:.8px;
      text-shadow: 0 2px 8px rgba(0,0,0,.7);
    }
    .unit{
      position:absolute;
      left:12px;
      bottom:14px;
      font-size:12px;
      color:var(--muted);
      opacity:.9;
    }
    .value{
      position:absolute;
      left:0; right:0;
      top:50%;
      transform: translateY(-42px);
      text-align:center;
      font-size:44px;
      font-weight:900;
      letter-spacing:.2px;
      text-shadow: 0 3px 14px rgba(0,0,0,.75);
    }
    .trend{
      position:absolute;
      left:0; right:0;
      top:50%;
      transform: translateY(8px);
      text-align:center;
      font-size:13px;
      color:var(--muted);
    }
    .badge{
      position:absolute;
      right:10px;
      top:10px;
      font-size:11px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.09);
      color: var(--muted);
    }

    .bottombar{
      height:42px;
      display:flex;
      align-items:center;
      padding:0 10px;
      gap:10px;
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(255,255,255,.03));
      border-top:1px solid rgba(255,255,255,.06);
    }
    .status{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 44vw;
    }
    .bar{
      flex:1;
      height:10px;
      border-radius: 999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.07);
    }
    .bar > div{
      height:100%;
      width:35%;
      background: linear-gradient(90deg, rgba(85,183,255,.15), rgba(85,183,255,.65), rgba(85,183,255,.15));
      filter: blur(.1px);
      animation: sweep 2.2s linear infinite;
    }
    @keyframes sweep{
      0%{ transform: translateX(-40%); }
      100%{ transform: translateX(320%); }
    }
    .alarm{
      font-weight:800;
      letter-spacing:.3px;
      padding:6px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(255,255,255,.06);
    }
    .alarm.ok{ color: var(--ok); border-color: rgba(52,199,89,.25); }
    .alarm.warn{ color: var(--warn); border-color: rgba(255,214,10,.25); }
    .alarm.danger{ color: var(--danger); border-color: rgba(255,59,48,.25); }

    /* Panel rápido (solo para test) */
    .panel{
      position:absolute;
      right:12px;
      bottom:56px;
      width: 280px;
      border-radius: 12px;
      background: rgba(10,12,16,.78);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 45px rgba(0,0,0,.55);
      padding:10px;
      backdrop-filter: blur(8px);
    }
    .panel h3{
      margin:0 0 8px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:800;
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .row{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .row .btn{ flex:1; height:34px; border-radius: 10px; font-size:12px; }
    .tiny{
      font-size:11px;
      color: var(--muted);
      opacity:.9;
      line-height:1.3;
    }
  </style>
</head>
<body>
  <div class="monitor" id="monitor">
    <div class="topbar">
      <div class="brand">
        <span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:var(--accent);box-shadow:0 0 18px rgba(85,183,255,.55)"></span>
        Monitor Hemodinámico (sim)
      </div>
      <span class="pill" id="modePill">LOCAL</span>

      <div class="spacer"></div>

      <select class="select" id="scenarioSelect"></select>
      <button class="btn primary" id="btnPlay">▶︎ Play</button>
      <button class="btn danger" id="btnReset">↺ Reset</button>
    </div>

    <div class="grid">
      <div class="tile" id="tile-ci">
        <div class="dialWrap"><canvas class="gauge" id="g-ci"></canvas></div>
        <div class="badge" id="badge-ci">CI</div>
        <div class="value" id="v-ci">--</div>
        <div class="trend" id="t-ci">--</div>
        <div class="label">CI</div>
        <div class="unit">L/min/m²</div>
      </div>

      <div class="tile" id="tile-svv">
        <div class="dialWrap"><canvas class="gauge" id="g-svv"></canvas></div>
        <div class="badge" id="badge-svv">SVV válido</div>
        <div class="value" id="v-svv">--</div>
        <div class="trend" id="t-svv">--</div>
        <div class="label">SVV</div>
        <div class="unit">%</div>
      </div>

      <div class="tile" id="tile-svri">
        <div class="dialWrap"><canvas class="gauge" id="g-svri"></canvas></div>
        <div class="badge" id="badge-svri">SVRI</div>
        <div class="value" id="v-svri">--</div>
        <div class="trend" id="t-svri">--</div>
        <div class="label">SVRI</div>
        <div class="unit">dyn·s·cm⁻⁵·m²</div>
      </div>

      <div class="tile" id="tile-scv">
        <div class="dialWrap"><canvas class="gauge" id="g-scv"></canvas></div>
        <div class="badge" id="badge-scv">ScvO₂</div>
        <div class="value" id="v-scv">--</div>
        <div class="trend" id="t-scv">--</div>
        <div class="label">ScvO₂</div>
        <div class="unit">%</div>
      </div>
    </div>

    <div class="bottombar">
      <div class="status" id="status">Listo.</div>
      <div class="bar"><div></div></div>
      <div class="alarm ok" id="alarm">OK</div>
    </div>

    <!-- panel solo para test -->
    <div class="panel" id="panel">
      <h3>Intervenciones (test)</h3>
      <div class="row">
        <button class="btn" id="bolus250">Bolus 250 mL</button>
        <button class="btn" id="bolus500">Bolus 500 mL</button>
      </div>
      <div class="row">
        <button class="btn" id="noraUp">Nora +</button>
        <button class="btn" id="noraDown">Nora −</button>
      </div>
      <div class="row">
        <button class="btn" id="inoUp">Inotrópico +</button>
        <button class="btn" id="inoDown">Inotrópico −</button>
      </div>
      <div class="row">
        <button class="btn" id="tx">Transfusión</button>
        <button class="btn" id="toggleSVV">Toggle validez SVV</button>
      </div>
      <div class="tiny" id="debugTiny"></div>
    </div>
  </div>

<script>
/** =========================
 * CONFIG
 * ========================== */
const CONFIG = {
  // ✅ Pegá acá tu URL del Web App de Google Apps Script (Deploy > Web app)
  // Ejemplo: "https://script.google.com/macros/s/AKfycbx....../exec"
  GAS_URL: "",

  // Para evitar CORS, usamos JSONP si GAS_URL está configurada
  USE_JSONP: true,

  // Timing
  PHYSIO_HZ: 1,        // cálculo fisiológico 1 Hz
  RENDER_FPS: 60,      // animación
  TREND_WINDOW_SEC: 300, // 5 min

  // Estética
  DIAL_START: Math.PI * 0.75,   // 135°
  DIAL_END:   Math.PI * 2.25,   // 405° (270° sweep)
};

const fmt = {
  ci: (x)=> x.toFixed(1),
  svv:(x)=> Math.round(x).toString(),
  svri:(x)=> Math.round(x).toString(),
  scv:(x)=> Math.round(x).toString()
};

function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function smoothDamp(current, target, lambda, dt){
  // expo smoothing
  const t = 1 - Math.exp(-lambda*dt);
  return current + (target-current)*t;
}

/** =========================
 * JSONP helper (para GAS cross-domain)
 * ========================== */
function jsonp(url, params={}){
  return new Promise((resolve, reject)=>{
    const cbName = "cb_" + Math.random().toString(36).slice(2);
    params.callback = cbName;
    const qs = new URLSearchParams(params).toString();
    const script = document.createElement("script");
    script.src = url + (url.includes("?") ? "&" : "?") + qs;

    window[cbName] = (data)=>{
      resolve(data);
      cleanup();
    };
    script.onerror = (e)=>{
      reject(new Error("JSONP error"));
      cleanup();
    };
    function cleanup(){
      delete window[cbName];
      script.remove();
    }
    document.head.appendChild(script);
  });
}

/** =========================
 * GAUGE
 * ========================== */
class Gauge {
  constructor(canvas, options){
    this.canvas = canvas;
    this.ctx = canvas.getContext("2d");
    this.options = options;
    this.value = options.min;
    this.target = options.min;
    this.history = [];
    this.valid = true; // para SVV
    this.resize();
    window.addEventListener("resize", ()=>this.resize());
  }

  resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = this.canvas.getBoundingClientRect();
    this.canvas.width = Math.max(10, Math.floor(rect.width * dpr));
    this.canvas.height = Math.max(10, Math.floor(rect.height * dpr));
    this.ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS px
  }

  setTarget(v){ this.target = v; }
  pushHistory(v){
    const now = performance.now()/1000;
    this.history.push({t: now, v});
    const cutoff = now - CONFIG.TREND_WINDOW_SEC;
    while(this.history.length && this.history[0].t < cutoff) this.history.shift();
  }

  trend5min(){
    if(this.history.length < 4) return {dir:0, pct:0};
    const now = performance.now()/1000;
    const cutoff = now - CONFIG.TREND_WINDOW_SEC;
    let first = null;
    for(const p of this.history){
      if(p.t >= cutoff){ first = p; break; }
    }
    if(!first) first = this.history[0];
    const last = this.history[this.history.length-1];
    const base = Math.max(1e-6, Math.abs(first.v));
    const pct = ((last.v - first.v)/base) * 100;
    const dir = pct > 0.5 ? 1 : (pct < -0.5 ? -1 : 0);
    return {dir, pct};
  }

  zoneFor(v){
    const z = this.options.zones;
    // zones: [{from,to,colorKey}] in ascending order
    for(const zone of z){
      if(v >= zone.from && v <= zone.to) return zone.colorKey;
    }
    // fuera de rango
    return (v < this.options.min || v > this.options.max) ? "danger" : "warn";
  }

  valueToAngle(v){
    const {min,max} = this.options;
    const t = (clamp(v,min,max) - min) / (max - min);
    const a = lerp(CONFIG.DIAL_START, CONFIG.DIAL_END, t);
    return a;
  }

  draw(){
    const ctx = this.ctx;
    const w = this.canvas.getBoundingClientRect().width;
    const h = this.canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,w,h);

    // layout
    const cx = w/2, cy = h/2 + 4;
    const r = Math.min(w,h) * 0.42;
    const ring = r * 0.18;
    const innerR = r - ring*1.15;

    // subtle shadow
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx,cy,r*1.02,0,Math.PI*2);
    ctx.shadowColor = "rgba(0,0,0,.65)";
    ctx.shadowBlur = 18;
    ctx.fillStyle = "rgba(0,0,0,.25)";
    ctx.fill();
    ctx.restore();

    // ticks
    const tickN = 40;
    ctx.save();
    ctx.translate(cx,cy);
    ctx.strokeStyle = "rgba(255,255,255,.65)";
    ctx.lineWidth = 2;
    for(let i=0;i<tickN;i++){
      const t = i/(tickN-1);
      const a = lerp(CONFIG.DIAL_START, CONFIG.DIAL_END, t);
      const x1 = Math.cos(a) * (r + 2);
      const y1 = Math.sin(a) * (r + 2);
      const x2 = Math.cos(a) * (r + (i%5===0? 12: 8));
      const y2 = Math.sin(a) * (r + (i%5===0? 12: 8));
      ctx.globalAlpha = (i%5===0)? .9 : .55;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
    }
    ctx.restore();

    // colored zones arc
    const arcR = r;
    const arcW = ring;
    const zones = this.options.zones;
    for(const zone of zones){
      const a1 = this.valueToAngle(zone.from);
      const a2 = this.valueToAngle(zone.to);
      const grad = ctx.createLinearGradient(cx - arcR, cy, cx + arcR, cy);
      const c = colorFromKey(zone.colorKey);
      // gradient-ish
      grad.addColorStop(0, withAlpha(c, .65));
      grad.addColorStop(.5, withAlpha(c, .95));
      grad.addColorStop(1, withAlpha(c, .65));

      ctx.save();
      ctx.beginPath();
      ctx.strokeStyle = grad;
      ctx.lineWidth = arcW;
      ctx.lineCap = "round";
      ctx.globalAlpha = this.valid ? 1 : 0.35; // si no es confiable (SVV)
      ctx.arc(cx,cy,arcR, a1, a2, false);
      ctx.stroke();
      ctx.restore();
    }

    // inner glossy circle
    ctx.save();
    ctx.beginPath();
    ctx.arc(cx,cy,innerR,0,Math.PI*2);
    const g1 = ctx.createRadialGradient(cx- innerR*0.25, cy- innerR*0.45, innerR*0.15, cx, cy, innerR);
    g1.addColorStop(0,"rgba(255,255,255,.18)");
    g1.addColorStop(.35,"rgba(0,0,0,.25)");
    g1.addColorStop(1,"rgba(0,0,0,.65)");
    ctx.fillStyle = g1;
    ctx.fill();

    // top highlight
    ctx.beginPath();
    ctx.arc(cx, cy, innerR, Math.PI*1.1, Math.PI*1.9);
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.lineWidth = 6;
    ctx.stroke();
    ctx.restore();

    // needle
    const a = this.valueToAngle(this.value);
    const nx = cx + Math.cos(a) * (r - arcW*0.6);
    const ny = cy + Math.sin(a) * (r - arcW*0.6);

    ctx.save();
    ctx.shadowColor = "rgba(0,0,0,.7)";
    ctx.shadowBlur = 10;
    ctx.lineWidth = 5;
    ctx.strokeStyle = "rgba(255,255,255,.95)";
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(nx,ny);
    ctx.stroke();

    // needle head
    ctx.shadowBlur = 0;
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.beginPath();
    const headR = 7;
    ctx.arc(nx,ny,headR,0,Math.PI*2);
    ctx.fill();

    // center hub
    ctx.beginPath();
    ctx.arc(cx,cy,10,0,Math.PI*2);
    ctx.fillStyle = "rgba(240,240,240,.9)";
    ctx.fill();
    ctx.beginPath();
    ctx.arc(cx,cy,6,0,Math.PI*2);
    ctx.fillStyle = "rgba(30,30,30,.85)";
    ctx.fill();
    ctx.restore();

    // sparkline
    this.drawSparkline(ctx, cx, cy, innerR);
  }

  drawSparkline(ctx, cx, cy, innerR){
    const w = innerR*1.5;
    const h = 34;
    const x = cx - w/2;
    const y = cy + innerR*0.48;

    ctx.save();
    ctx.globalAlpha = .9;
    ctx.fillStyle = "rgba(0,0,0,.22)";
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    roundRect(ctx, x, y, w, h, 8, true, true);

    if(this.history.length > 2){
      const vs = this.history.map(p=>p.v);
      const vmin = Math.min(...vs), vmax = Math.max(...vs);
      const pad = 6;

      ctx.beginPath();
      for(let i=0;i<this.history.length;i++){
        const t = i/(this.history.length-1);
        const vx = x + pad + t*(w-2*pad);
        const vv = this.history[i].v;
        const tv = (vv - vmin) / (Math.max(1e-6, vmax - vmin));
        const vy = y + pad + (1-tv)*(h-2*pad);
        if(i===0) ctx.moveTo(vx,vy);
        else ctx.lineTo(vx,vy);
      }
      ctx.lineWidth = 2;
      ctx.strokeStyle = "rgba(255,255,255,.72)";
      ctx.stroke();
    }

    ctx.restore();
  }

  step(dt){
    this.value = smoothDamp(this.value, this.target, 6.0, dt);
    this.draw();
  }
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.arcTo(x+w, y, x+w, y+h, r);
  ctx.arcTo(x+w, y+h, x, y+h, r);
  ctx.arcTo(x, y+h, x, y, r);
  ctx.arcTo(x, y, x+w, y, r);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke){ ctx.stroke(); }
}

function colorFromKey(key){
  const map = {
    danger: getCss("--danger"),
    warn: getCss("--warn"),
    ok: getCss("--ok")
  };
  return map[key] || getCss("--accent");
}
function getCss(name){
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
function withAlpha(hexOrRgb, a){
  // accept rgb(...) already
  if(hexOrRgb.startsWith("rgb")){
    return hexOrRgb.replace("rgb(", "rgba(").replace(")", `, ${a})`);
  }
  // hex #rrggbb
  const h = hexOrRgb.replace("#","");
  const r = parseInt(h.slice(0,2),16);
  const g = parseInt(h.slice(2,4),16);
  const b = parseInt(h.slice(4,6),16);
  return `rgba(${r},${g},${b},${a})`;
}

/** =========================
 * ESCENARIOS (LOCAL)
 * ========================== */
const LOCAL_SCENARIOS = [
  {
    id:"hipovolemia",
    nombre:"Hipovolemia (respondedor a fluidos)",
    meta:"SVV alto, CI bajo-normal, SVRI alto, ScvO2 baja",
    init:{ preload:0.35, contract:0.62, tone:0.70, vo2:0.55, svvValid:true, hb:10.5, sao2:98, bsa:1.85 }
  },
  {
    id:"vasoplejia",
    nombre:"Vasoplejía (anestesia profunda / sepsis early)",
    meta:"SVRI bajo, CI normal-alto, ScvO2 normal-alta, SVV variable",
    init:{ preload:0.55, contract:0.70, tone:0.30, vo2:0.55, svvValid:true, hb:11.0, sao2:97, bsa:1.90 }
  },
  {
    id:"fallo_bomba",
    nombre:"Disfunción contráctil",
    meta:"CI bajo, SVV no tan alto, SVRI alto, ScvO2 baja",
    init:{ preload:0.55, contract:0.35, tone:0.75, vo2:0.60, svvValid:true, hb:10.0, sao2:96, bsa:1.80 }
  },
  {
    id:"alto_vo2",
    nombre:"Demanda alta (VO2 ↑)",
    meta:"ScvO2 cae con CI variable",
    init:{ preload:0.55, contract:0.65, tone:0.55, vo2:0.85, svvValid:true, hb:12.0, sao2:97, bsa:1.88 }
  },
];

/** =========================
 * MODELO FISIOLÓGICO (simple coherente)
 * variables normalizadas 0..1:
 * preload (precarga), contract (contractilidad), tone (tono vascular), vo2 (demanda)
 * ========================== */
function derivePhysio(s){
  // constantes base
  const BSA = s.bsa ?? 1.85;

  // FC base (bpm) en rango 55-120 según estrés/compensación
  const fc = 60 + 55*(1 - s.preload) + 10*(s.vo2 - 0.5);
  // VS base (mL) escala 35-95 según preload y contractilidad y poscarga (tone)
  const afterloadPenalty = 0.25 + 0.85*s.tone; // 0.25..1.1
  const vs = 35 + 75 * (0.55*s.preload + 0.55*s.contract) / afterloadPenalty; // aprox
  // CO (L/min)
  const co = (fc * vs) / 1000;

  const ci = co / BSA;

  // SVV: sube si preload bajo y si "ventilación controlada" (valid)
  let svv = 4 + 28*(1 - s.preload) + 4*(s.tone - 0.5);
  svv = clamp(svv, 2, 35);

  // SVRI (dyn s cm^-5 m^2) depende de tono / co
  // idea: SVRI ~ tone / CI con escala clínica
  let svri = 900 + 2400*(s.tone) - 450*(ci - 2.5);
  svri = clamp(svri, 500, 3200);

  // DO2 relativo (simplificado): CO * Hb * SaO2
  const hb = s.hb ?? 11;
  const sao2 = (s.sao2 ?? 97)/100;
  const do2Rel = co * hb * sao2;

  // ScvO2 depende de DO2/VO2 (muy simplificado)
  // vo2 0.3..1.0 => mayor demanda reduce scv
  let scv = 78 + 10*(do2Rel - 6.0) - 28*(s.vo2 - 0.55);
  scv = clamp(scv, 45, 90);

  // MAP (mmHg) interno (solo para debug)
  const map = clamp(55 + 55*s.tone + 4*(ci-2.5), 45, 110);

  return {ci, svv, svri, scv, fc, vs, co, map};
}

/** =========================
 * RANGOS + ZONAS (tuneables)
 * ========================== */
const PARAMS = {
  ci: {
    min:0, max:8,
    zones: [
      {from:0,   to:1.8, colorKey:"danger"},
      {from:1.8, to:2.4, colorKey:"warn"},
      {from:2.4, to:4.2, colorKey:"ok"},
      {from:4.2, to:5.5, colorKey:"warn"},
      {from:5.5, to:8.0, colorKey:"danger"},
    ]
  },
  svv:{
    min:0, max:40,
    zones: [
      {from:0,  to:4,  colorKey:"warn"},
      {from:4,  to:12, colorKey:"ok"},
      {from:12, to:20, colorKey:"warn"},
      {from:20, to:40, colorKey:"danger"},
    ]
  },
  svri:{
    min:500, max:3200,
    zones: [
      {from:500, to:1100, colorKey:"danger"},
      {from:1100,to:1600, colorKey:"warn"},
      {from:1600,to:2400, colorKey:"ok"},
      {from:2400,to:2800, colorKey:"warn"},
      {from:2800,to:3200, colorKey:"danger"},
    ]
  },
  scv:{
    min:40, max:90,
    zones: [
      {from:40, to:60, colorKey:"danger"},
      {from:60, to:70, colorKey:"warn"},
      {from:70, to:82, colorKey:"ok"},
      {from:82, to:88, colorKey:"warn"},
      {from:88, to:90, colorKey:"danger"},
    ]
  }
};

/** =========================
 * APP STATE
 * ========================== */
const UI = {
  scenarioSelect: document.getElementById("scenarioSelect"),
  status: document.getElementById("status"),
  alarm: document.getElementById("alarm"),
  modePill: document.getElementById("modePill"),
  debugTiny: document.getElementById("debugTiny"),

  v_ci: document.getElementById("v-ci"),
  v_svv: document.getElementById("v-svv"),
  v_svri: document.getElementById("v-svri"),
  v_scv: document.getElementById("v-scv"),

  t_ci: document.getElementById("t-ci"),
  t_svv: document.getElementById("t-svv"),
  t_svri: document.getElementById("t-svri"),
  t_scv: document.getElementById("t-scv"),

  badge_svv: document.getElementById("badge-svv"),

  btnPlay: document.getElementById("btnPlay"),
  btnReset: document.getElementById("btnReset"),
};

const gauges = {
  ci: new Gauge(document.getElementById("g-ci"), { ...PARAMS.ci }),
  svv: new Gauge(document.getElementById("g-svv"), { ...PARAMS.svv }),
  svri: new Gauge(document.getElementById("g-svri"), { ...PARAMS.svri }),
  scv: new Gauge(document.getElementById("g-scv"), { ...PARAMS.scv }),
};

let running = false;
let lastRender = performance.now();
let physioTimer = null;

const patient = {
  // variables normalizadas
  preload: 0.55,
  contract:0.65,
  tone:0.55,
  vo2:0.55,
  hb: 11.0,
  sao2: 97,
  bsa: 1.85,
  svvValid: true,

  // controles (simulados)
  nora: 0.0,    // -1..+1
  ino: 0.0,     // -1..+1
};

let scenarios = []; // cargados local o GAS
let currentScenario = null;

/** =========================
 * DATA SOURCE: LOCAL o GAS
 * ========================== */
async function loadScenarios(){
  if(CONFIG.GAS_URL){
    UI.modePill.textContent = "SHEETS";
    UI.status.textContent = "Cargando escenarios desde Google Sheets...";
    try{
      const data = CONFIG.USE_JSONP
        ? await jsonp(CONFIG.GAS_URL, { action:"listScenarios" })
        : await (await fetch(CONFIG.GAS_URL + "?action=listScenarios")).json();

      if(!data || !data.ok) throw new Error("Respuesta inválida");
      scenarios = data.scenarios;
      UI.status.textContent = `Escenarios cargados (${scenarios.length}).`;
      return;
    }catch(e){
      UI.status.textContent = "No pude leer Sheets. Paso a LOCAL (revisá GAS_URL / deploy / permisos).";
      scenarios = LOCAL_SCENARIOS.map(s => ({
        id:s.id, nombre:s.nombre, meta:s.meta, init:s.init
      }));
      UI.modePill.textContent = "LOCAL";
      return;
    }
  }
  UI.modePill.textContent = "LOCAL";
  scenarios = LOCAL_SCENARIOS.map(s => ({id:s.id, nombre:s.nombre, meta:s.meta, init:s.init}));
}

function populateScenarioSelect(){
  UI.scenarioSelect.innerHTML = "";
  for(const sc of scenarios){
    const opt = document.createElement("option");
    opt.value = sc.id;
    opt.textContent = sc.nombre;
    UI.scenarioSelect.appendChild(opt);
  }
}

async function loadScenarioById(id){
  if(CONFIG.GAS_URL){
    // si viene de Sheets, pedimos payload completo (por si querés rangos/sensibilidades)
    try{
      const data = CONFIG.USE_JSONP
        ? await jsonp(CONFIG.GAS_URL, { action:"getScenario", id })
        : await (await fetch(CONFIG.GAS_URL + `?action=getScenario&id=${encodeURIComponent(id)}`)).json();
      if(data && data.ok && data.scenario){
        return data.scenario;
      }
    }catch(e){}
  }
  // fallback local
  return scenarios.find(s=>s.id===id) || scenarios[0];
}

/** =========================
 * ESCENARIO -> ESTADO PACIENTE
 * ========================== */
function applyScenario(sc){
  currentScenario = sc;
  const init = sc.init || sc;
  patient.preload = init.preload ?? 0.55;
  patient.contract= init.contract ?? 0.65;
  patient.tone    = init.tone ?? 0.55;
  patient.vo2     = init.vo2 ?? 0.55;
  patient.hb      = init.hb ?? 11.0;
  patient.sao2    = init.sao2 ?? 97;
  patient.bsa     = init.bsa ?? 1.85;
  patient.svvValid= init.svvValid ?? true;
  patient.nora = 0;
  patient.ino = 0;

  // reset history
  for(const k of Object.keys(gauges)){
    gauges[k].history = [];
  }
  UI.status.textContent = sc.meta ? sc.meta : `Escenario: ${sc.nombre}`;
}

/** =========================
 * INTERVENCIONES (test)
 * ========================== */
function bolus(ml){
  // aumenta preload; efecto decrece según preload actual
  const dose = ml/500; // 0.5 o 1
  const gain = (0.20 * dose) * (1 - patient.preload*0.7);
  patient.preload = clamp(patient.preload + gain, 0.05, 0.95);
  UI.status.textContent = `Bolus ${ml} mL → precarga +${(gain*100).toFixed(0)}%.`;
}
function nora(delta){
  patient.nora = clamp(patient.nora + delta, -1, 1);
  UI.status.textContent = `Noradrenalina: ${(patient.nora*100).toFixed(0)}% (sim).`;
}
function ino(delta){
  patient.ino = clamp(patient.ino + delta, -1, 1);
  UI.status.textContent = `Inotrópico: ${(patient.ino*100).toFixed(0)}% (sim).`;
}
function transfusion(){
  patient.hb = clamp(patient.hb + 1.0, 6, 16);
  UI.status.textContent = `Transfusión → Hb ${patient.hb.toFixed(1)} g/dL.`;
}
function toggleSVVValid(){
  patient.svvValid = !patient.svvValid;
  UI.status.textContent = `SVV ahora: ${patient.svvValid ? "VÁLIDO" : "NO confiable"}.`;
}

/** =========================
 * LOOP FISIOLÓGICO
 * ========================== */
function physioStep(){
  // aplicar drogas a variables (simple)
  // nora: sube tono; si se pasa, aumenta poscarga y puede bajar VS/CI
  patient.tone = clamp(patient.tone + 0.06*patient.nora, 0.05, 0.95);
  // inotrópico: sube contractilidad
  patient.contract = clamp(patient.contract + 0.05*patient.ino, 0.05, 0.95);

  // drift fisiológico suave hacia baseline del escenario (para que no se “rompa”)
  const base = (currentScenario?.init) || {};
  patient.preload  = smoothDamp(patient.preload,  base.preload  ?? patient.preload,  0.18, 1);
  patient.contract = smoothDamp(patient.contract, base.contract ?? patient.contract, 0.12, 1);
  patient.tone     = smoothDamp(patient.tone,     base.tone     ?? patient.tone,     0.10, 1);
  patient.vo2      = smoothDamp(patient.vo2,      base.vo2      ?? patient.vo2,      0.08, 1);

  // ruido mínimo
  const noise = ()=> (Math.random()-0.5);
  const p = derivePhysio(patient);

  // si SVV no es confiable (espontáneo/arrítmico), lo “desacoplamos” parcialmente
  const svvShown = patient.svvValid ? p.svv : clamp(10 + 6*noise(), 4, 18);

  // targets a gauges
  gauges.ci.setTarget(p.ci + 0.05*noise());
  gauges.svv.setTarget(svvShown);
  gauges.svri.setTarget(p.svri + 20*noise());
  gauges.scv.setTarget(p.scv + 1.0*noise());

  // historia para trend
  gauges.ci.pushHistory(p.ci);
  gauges.svv.pushHistory(svvShown);
  gauges.svri.pushHistory(p.svri);
  gauges.scv.pushHistory(p.scv);

  // badge SVV
  gauges.svv.valid = patient.svvValid;
  UI.badge_svv.textContent = patient.svvValid ? "SVV válido" : "SVV no confiable";

  // debug
  UI.debugTiny.textContent =
    `FC ~ ${Math.round(p.fc)} bpm  | VS ~ ${Math.round(p.vs)} mL  | CO ~ ${p.co.toFixed(1)} L/min  | MAP ~ ${Math.round(p.map)} mmHg`;
}

/** =========================
 * LOOP RENDER
 * ========================== */
function renderLoop(now){
  const dt = (now - lastRender)/1000;
  lastRender = now;

  // step gauges
  gauges.ci.step(dt);
  gauges.svv.step(dt);
  gauges.svri.step(dt);
  gauges.scv.step(dt);

  // update text
  const ci = gauges.ci.value;
  const svv= gauges.svv.value;
  const svri=gauges.svri.value;
  const scv=gauges.scv.value;

  UI.v_ci.textContent   = fmt.ci(ci);
  UI.v_svv.textContent  = fmt.svv(svv);
  UI.v_svri.textContent = fmt.svri(svri);
  UI.v_scv.textContent  = fmt.scv(scv);

  // trends
  const tr_ci = gauges.ci.trend5min();
  const tr_svv = gauges.svv.trend5min();
  const tr_svri = gauges.svri.trend5min();
  const tr_scv = gauges.scv.trend5min();

  UI.t_ci.textContent   = trendText(tr_ci);
  UI.t_svv.textContent  = trendText(tr_svv);
  UI.t_svri.textContent = trendText(tr_svri);
  UI.t_scv.textContent  = trendText(tr_scv);

  // alarm summary
  const z1 = gauges.ci.zoneFor(ci);
  const z2 = gauges.svv.zoneFor(svv);
  const z3 = gauges.svri.zoneFor(svri);
  const z4 = gauges.scv.zoneFor(scv);
  const worst = worstZone([z1,z2,z3,z4]);
  setAlarm(worst);

  if(running) requestAnimationFrame(renderLoop);
}

function trendText(tr){
  const arrow = tr.dir>0 ? "↑" : (tr.dir<0 ? "↓" : "→");
  const pct = Math.abs(tr.pct);
  if(pct < 0.6) return `${arrow} 0% (5 min)`;
  return `${arrow} ${pct.toFixed(0)}% (5 min)`;
}
function worstZone(zs){
  // danger > warn > ok
  if(zs.includes("danger")) return "danger";
  if(zs.includes("warn")) return "warn";
  return "ok";
}
function setAlarm(key){
  UI.alarm.className = "alarm " + key;
  UI.alarm.textContent = key === "ok" ? "OK" : (key === "warn" ? "ATENCIÓN" : "ALARMA");
}

/** =========================
 * CONTROLES
 * ========================== */
UI.btnPlay.addEventListener("click", ()=>{
  running = !running;
  UI.btnPlay.textContent = running ? "⏸ Pause" : "▶︎ Play";

  if(running){
    lastRender = performance.now();
    if(!physioTimer) physioTimer = setInterval(physioStep, 1000/CONFIG.PHYSIO_HZ);
    requestAnimationFrame(renderLoop);
  }else{
    if(physioTimer){ clearInterval(physioTimer); physioTimer = null; }
  }
});

UI.btnReset.addEventListener("click", async ()=>{
  const id = UI.scenarioSelect.value;
  const sc = await loadScenarioById(id);
  applyScenario(sc);
  // fuerza un update visible
  physioStep();
});

UI.scenarioSelect.addEventListener("change", async ()=>{
  const id = UI.scenarioSelect.value;
  const sc = await loadScenarioById(id);
  applyScenario(sc);
  physioStep();
});

// Panel test
document.getElementById("bolus250").onclick = ()=> bolus(250);
document.getElementById("bolus500").onclick = ()=> bolus(500);
document.getElementById("noraUp").onclick = ()=> nora(+0.25);
document.getElementById("noraDown").onclick = ()=> nora(-0.25);
document.getElementById("inoUp").onclick = ()=> ino(+0.25);
document.getElementById("inoDown").onclick = ()=> ino(-0.25);
document.getElementById("tx").onclick = ()=> transfusion();
document.getElementById("toggleSVV").onclick = ()=> toggleSVVValid();

/** =========================
 * INIT
 * ========================== */
(async function init(){
  await loadScenarios();
  populateScenarioSelect();
  const firstId = scenarios[0]?.id;
  UI.scenarioSelect.value = firstId;
  const sc = await loadScenarioById(firstId);
  applyScenario(sc);

  // primer frame
  physioStep();
  // arranca pausado (vos le das play)
  lastRender = performance.now();
  gauges.ci.draw(); gauges.svv.draw(); gauges.svri.draw(); gauges.scv.draw();

  UI.status.textContent = (currentScenario?.meta) || "Listo. Elegí escenario y dale Play.";
})();
</script>
</body>
</html>
